#############################################################################
$log_group_name = 'customer-CloudWatch-EC2-Windows-APP_ID-1591'
$log_list = @{}
$log_location = 'C:\LogFiles\AssuranceConfig\Acon.log'
$log_stream_name = 'ACon'
$log_list.add($log_location,$log_stream_Name)
$log_location = 'C:\LogFiles\AssuranceConfig\AconCli.log'
$log_stream_name = 'AConCli'
$log_list.add($log_location,$log_stream_Name)
$log_location = 'c:\logfiles\AiiService*.log'
$log_stream_name = 'AiiService'
$log_list.add($log_location,$log_stream_Name)
$log_location = 'c:\logfiles\AntPayCalcJob*'
$log_stream_name = 'AntPayCalcJob'
$log_list.add($log_location,$log_stream_Name)
$log_location = 'c:\logfiles\AntPayFinalizeJo*'
$log_stream_name = 'AntPayFinalizeJob'
$log_list.add($log_location,$log_stream_Name)
$log_location = 'C:\LogFiles\AntPayFollowUpJob*.log'
$log_stream_name = 'AntPayFollowUpJobs'
$log_list.add($log_location,$log_stream_Name)
$log_location = 'c:\logfiles\AppealsRequestService*.log'
$log_stream_name = 'AppealsRequestService'
$log_list.add($log_location,$log_stream_Name)
$log_location = 'c:\logfiles\AttmUnsolFollowUpSrvc*.log'
$log_stream_name = 'AttmUnsolFollowUpSrvc'
$log_list.add($log_location,$log_stream_Name)
$log_location = 'c:\logfiles\AttmUnsolRequestPWKSrvc*.log'
$log_stream_name = 'AttmUnsolRequestPWKSrvc'
$log_list.add($log_location,$log_stream_Name)
$log_location = 'c:\logfiles\AttmUnsolUpdatePWKSrvc*.log'
$log_stream_name = 'AttmUnsolUpdatePWKSrvc'
$log_list.add($log_location,$log_stream_Name)
$log_location = 'c:\logfiles\AutoAttmCreateService*.log'
$log_stream_name = 'AutoAttmCreateService'
$log_list.add($log_location,$log_stream_Name)
$log_location = 'c:\logfiles\AutoAttmFinalizeService*.log'
$log_stream_name = 'AutoAttmFinalizeService'
$log_list.add($log_location,$log_stream_Name)
$log_location = 'c:\logfiles\AutoAttmUpdateService*.log'
$log_stream_name = 'AutoAttmUpdateService'
$log_list.add($log_location,$log_stream_Name)
$log_location = 'c:\logfiles\backend.log'
$log_stream_name = 'backend'
$log_list.add($log_location,$log_stream_Name)
$log_location = 'c:\logfiles\Backfeed.log'
$log_stream_name = 'Backfeed'
$log_list.add($log_location,$log_stream_Name)
$log_location = 'c:\logfiles\BI*.log'
$log_stream_name = 'BI'
$log_list.add($log_location,$log_stream_Name)
$log_location = 'c:\logfiles\BIAudit*.log'
$log_stream_name = 'BIAudit'
$log_list.add($log_location,$log_stream_Name)
$log_location = 'c:\logfiles\ClaimAssignmentNotificationService*.log'
$log_stream_name = 'ClaimAssignmentNotificationService'
$log_list.add($log_location,$log_stream_Name)
$log_location = 'C:\ehospital\CoreVersion.txt'
$log_stream_name = 'CoreVersion'
$log_list.add($log_location,$log_stream_Name)
$log_location = 'D:\RabbitMQ\log\log\crash.log'
$log_stream_name = 'Crashlog'
$log_list.add($log_location,$log_stream_Name)
$log_location = 'c:\logfiles\CTService*.log'
$log_stream_name = 'CTService'
$log_list.add($log_location,$log_stream_Name)
$log_location = 'c:\logfiles\Eligibility271ResponseParser*.log'
$log_stream_name = 'Eligibility271ResponseParser'
$log_list.add($log_location,$log_stream_Name)
$log_location = 'c:\logfiles\EligibilityAuditService*.log'
$log_stream_name = 'EligibilityAuditService'
$log_list.add($log_location,$log_stream_Name)
$log_location = 'c:\logfiles\EligibilityDataStorageService*.log'
$log_stream_name = 'EligibilityDataStorageService'
$log_list.add($log_location,$log_stream_Name)
$log_location = 'c:\logfiles\EligibilityErrorService*.log'
$log_stream_name = 'EligibilityErrorService'
$log_list.add($log_location,$log_stream_Name)
$log_location = 'c:\logfiles\EligibilityFormatterService*.log'
$log_stream_name = 'EligibilityFormatterService'
$log_list.add($log_location,$log_stream_Name)
$log_location = 'c:\logfiles\EligibilityGatewayService*.log'
$log_stream_name = 'EligibilityGatewayService'
$log_list.add($log_location,$log_stream_Name)
$log_location = 'c:\logfiles\EligibilityHeldRequestService*.log'
$log_stream_name = 'EligibilityHeldRequestService'
$log_list.add($log_location,$log_stream_Name)
$log_location = 'c:\logfiles\EligibilityRequestService*.log'
$log_stream_name = 'EligibilityRequestService'
$log_list.add($log_location,$log_stream_Name)
$log_location = 'c:\logfiles\EligibilityStatusMonitorService*.log'
$log_stream_name = 'EligibilityStatusMonitorService'
$log_list.add($log_location,$log_stream_Name)
$log_location = 'C:\LogFiles\epremis_web\epremis_web.log'
$log_stream_name = 'Epremis_Web'
$log_list.add($log_location,$log_stream_Name)
$log_location = 'C:\Program Files\RelayHealth\jboss-logs\freemem.log'
$log_stream_name = 'Freemem'
$log_list.add($log_location,$log_stream_Name)
$log_location = 'c:\logfiles\HistoricalErrors*.log'
$log_stream_name = 'HistoricalErrors'
$log_list.add($log_location,$log_stream_Name)
$log_location = 'c:\logfiles\InterOp.log'
$log_stream_name = 'InterOp'
$log_list.add($log_location,$log_stream_Name)
$log_location = 'c:\logfiles\InterOp.1.log'
$log_stream_name = 'InterOp.1'
$log_list.add($log_location,$log_stream_Name)
$log_location = 'c:\logfiles\InterOp.10.log'
$log_stream_name = 'InterOp.10'
$log_list.add($log_location,$log_stream_Name)
$log_location = 'c:\logfiles\InterOp.11.log'
$log_stream_name = 'InterOp.11'
$log_list.add($log_location,$log_stream_Name)
$log_location = 'c:\logfiles\InterOp.12.log'
$log_stream_name = 'InterOp.12'
$log_list.add($log_location,$log_stream_Name)
$log_location = 'c:\logfiles\InterOp.13.log'
$log_stream_name = 'InterOp.13'
$log_list.add($log_location,$log_stream_Name)
$log_location = 'c:\logfiles\InterOp.14.log'
$log_stream_name = 'InterOp.14'
$log_list.add($log_location,$log_stream_Name)
$log_location = 'c:\logfiles\InterOp.15.log'
$log_stream_name = 'InterOp.15'
$log_list.add($log_location,$log_stream_Name)
$log_location = 'c:\logfiles\InterOp.16.log'
$log_stream_name = 'InterOp.16'
$log_list.add($log_location,$log_stream_Name)
$log_location = 'c:\logfiles\InterOp.17.log'
$log_stream_name = 'InterOp.17'
$log_list.add($log_location,$log_stream_Name)
$log_location = 'c:\logfiles\InterOp.18.log'
$log_stream_name = 'InterOp.18'
$log_list.add($log_location,$log_stream_Name)
$log_location = 'c:\logfiles\InterOp.19.log'
$log_stream_name = 'InterOp.19'
$log_list.add($log_location,$log_stream_Name)
$log_location = 'c:\logfiles\InterOp.2.log'
$log_stream_name = 'InterOp.2'
$log_list.add($log_location,$log_stream_Name)
$log_location = 'c:\logfiles\InterOp.20.log'
$log_stream_name = 'InterOp.20'
$log_list.add($log_location,$log_stream_Name)
$log_location = 'c:\logfiles\InterOp.21.log'
$log_stream_name = 'InterOp.21'
$log_list.add($log_location,$log_stream_Name)
$log_location = 'c:\logfiles\InterOp.22.log'
$log_stream_name = 'InterOp.22'
$log_list.add($log_location,$log_stream_Name)
$log_location = 'c:\logfiles\InterOp.23.log'
$log_stream_name = 'InterOp.23'
$log_list.add($log_location,$log_stream_Name)
$log_location = 'c:\logfiles\InterOp.24.log'
$log_stream_name = 'InterOp.24'
$log_list.add($log_location,$log_stream_Name)
$log_location = 'c:\logfiles\InterOp.25.log'
$log_stream_name = 'InterOp.25'
$log_list.add($log_location,$log_stream_Name)
$log_location = 'c:\logfiles\InterOp.26.log'
$log_stream_name = 'InterOp.26'
$log_list.add($log_location,$log_stream_Name)
$log_location = 'c:\logfiles\InterOp.27.log'
$log_stream_name = 'InterOp.27'
$log_list.add($log_location,$log_stream_Name)
$log_location = 'c:\logfiles\InterOp.28.log'
$log_stream_name = 'InterOp.28'
$log_list.add($log_location,$log_stream_Name)
$log_location = 'c:\logfiles\InterOp.29.log'
$log_stream_name = 'InterOp.29'
$log_list.add($log_location,$log_stream_Name)
$log_location = 'c:\logfiles\InterOp.3.log'
$log_stream_name = 'InterOp.3'
$log_list.add($log_location,$log_stream_Name)
$log_location = 'c:\logfiles\InterOp.30.log'
$log_stream_name = 'InterOp.30'
$log_list.add($log_location,$log_stream_Name)
$log_location = 'c:\logfiles\InterOp.31.log'
$log_stream_name = 'InterOp.31'
$log_list.add($log_location,$log_stream_Name)
$log_location = 'c:\logfiles\InterOp.32.log'
$log_stream_name = 'InterOp.32'
$log_list.add($log_location,$log_stream_Name)
$log_location = 'c:\logfiles\InterOp.33.log'
$log_stream_name = 'InterOp.33'
$log_list.add($log_location,$log_stream_Name)
$log_location = 'c:\logfiles\InterOp.34.log'
$log_stream_name = 'InterOp.34'
$log_list.add($log_location,$log_stream_Name)
$log_location = 'c:\logfiles\InterOp.35.log'
$log_stream_name = 'InterOp.35'
$log_list.add($log_location,$log_stream_Name)
$log_location = 'c:\logfiles\InterOp.36.log'
$log_stream_name = 'InterOp.36'
$log_list.add($log_location,$log_stream_Name)
$log_location = 'c:\logfiles\InterOp.37.log'
$log_stream_name = 'InterOp.37'
$log_list.add($log_location,$log_stream_Name)
$log_location = 'c:\logfiles\InterOp.38.log'
$log_stream_name = 'InterOp.38'
$log_list.add($log_location,$log_stream_Name)
$log_location = 'c:\logfiles\InterOp.39.log'
$log_stream_name = 'InterOp.39'
$log_list.add($log_location,$log_stream_Name)
$log_location = 'c:\logfiles\InterOp.4.log'
$log_stream_name = 'InterOp.4'
$log_list.add($log_location,$log_stream_Name)
$log_location = 'c:\logfiles\InterOp.40.log'
$log_stream_name = 'InterOp.40'
$log_list.add($log_location,$log_stream_Name)
$log_location = 'c:\logfiles\InterOp.41.log'
$log_stream_name = 'InterOp.41'
$log_list.add($log_location,$log_stream_Name)
$log_location = 'c:\logfiles\InterOp.42.log'
$log_stream_name = 'InterOp.42'
$log_list.add($log_location,$log_stream_Name)
$log_location = 'c:\logfiles\InterOp.5.log'
$log_stream_name = 'InterOp.5'
$log_list.add($log_location,$log_stream_Name)
$log_location = 'c:\logfiles\InterOp.6.log'
$log_stream_name = 'InterOp.6'
$log_list.add($log_location,$log_stream_Name)
$log_location = 'c:\logfiles\InterOp.7.log'
$log_stream_name = 'InterOp.7'
$log_list.add($log_location,$log_stream_Name)
$log_location = 'c:\logfiles\InterOp.8.log'
$log_stream_name = 'InterOp.8'
$log_list.add($log_location,$log_stream_Name)
$log_location = 'c:\logfiles\InterOp.9.log'
$log_stream_name = 'InterOp.9'
$log_list.add($log_location,$log_stream_Name)
$log_location = 'C:\Program Files\RelayHealth\jboss-eap-6.3\bin\run.txt'
$log_stream_name = 'JBossRun'
$log_list.add($log_location,$log_stream_Name)
$log_location = 'C:\Program Files\RelayHealth\jboss-eap-6.3\bin\shutdown.txt'
$log_stream_name = 'JBossShutdown'
$log_list.add($log_location,$log_stream_Name)
$log_location = 'C:\Program Files\RelayHealth\jboss-eap-6.3\bin\run.log'
$log_stream_name = 'JBossRun'
$log_list.add($log_location,$log_stream_Name)
$log_location = 'C:\Program Files\RelayHealth\jboss-eap-6.3\bin\shutdown.log'
$log_stream_name = 'JBossShutdown'
$log_list.add($log_location,$log_stream_Name)
$log_location = 'c:\logfiles\MassAppealCreateService*.log'
$log_stream_name = 'MassAppealCreateService'
$log_list.add($log_location,$log_stream_Name)
$log_location = 'c:\logfiles\MassAppealDeleteService*.log'
$log_stream_name = 'MassAppealDeleteService'
$log_list.add($log_location,$log_stream_Name)
$log_location = 'c:\logfiles\MassAppealUpdateService*.log'
$log_stream_name = 'MassAppealUpdateService'
$log_list.add($log_location,$log_stream_Name)
$log_location = 'c:\logfiles\MasterQueueService*.log'
$log_stream_name = 'MasterQueueService'
$log_list.add($log_location,$log_stream_Name)
$log_location = 'c:\logfiles\MetricsRequestService*.log'
$log_stream_name = 'MetricsRequestService'
$log_list.add($log_location,$log_stream_Name)
$log_location = 'c:\logfiles\p2dRequest.log'
$log_stream_name = 'p2dRequest'
$log_list.add($log_location,$log_stream_Name)
$log_location = 'c:\logfiles\PaperClaims*.log'
$log_stream_name = 'PaperClaims'
$log_list.add($log_location,$log_stream_Name)
$log_location = 'c:\logfiles\ParentMatchFinalizeService*.log'
$log_stream_name = 'ParentMatchFinalizeService'
$log_list.add($log_location,$log_stream_Name)
$log_location = 'c:\logfiles\ParentMatchRequestService*.log'
$log_stream_name = 'ParentMatchRequestService'
$log_list.add($log_location,$log_stream_Name)
$log_location = 'c:\logfiles\ParentMatchStorageService*.log'
$log_stream_name = 'ParentMatchStorageService'
$log_list.add($log_location,$log_stream_Name)
$log_location = 'c:\logfiles\PayerStatusDataStorageService*.log'
$log_stream_name = 'PayerStatusDataStorageService'
$log_list.add($log_location,$log_stream_Name)
$log_location = 'c:\logfiles\PayerStatusGatewayService*.log'
$log_stream_name = 'PayerStatusGatewayService'
$log_list.add($log_location,$log_stream_Name)
$log_location = 'c:\logfiles\PayerStatusRequestService*.log'
$log_stream_name = 'PayerStatusRequestService'
$log_list.add($log_location,$log_stream_Name)
$log_location = 'c:\logfiles\PayerStatusResponseParserService*.log'
$log_stream_name = 'PayerStatusResponseParserService'
$log_list.add($log_location,$log_stream_Name)
$log_location = 'C:\Program Files\RelayHealth\jboss-logs\Prefomance.log'
$log_stream_name = 'Perfomance'
$log_list.add($log_location,$log_stream_Name)
$log_location = 'c:\logfiles\PlatformServices\PlatformServices.log'
$log_stream_name = 'PlatformServices'
$log_list.add($log_location,$log_stream_Name)
$log_location = 'c:\logfiles\PlatformServices\*'
$log_stream_name = 'PlatformServices_pm'
$log_list.add($log_location,$log_stream_Name)
$log_location = 'c:\logfiles\PlatformServices\audit\backend*'
$log_stream_name = 'PlatformServices_audit_backend'
$log_list.add($log_location,$log_stream_Name)
$log_location = 'c:\logfiles\PlatformServices\audit\p2drequest*'
$log_stream_name = 'PlatformServices_audit_p2drequest'
$log_list.add($log_location,$log_stream_Name)
$log_location = 'c:\logfiles\PlatformServices\audit\session*'
$log_stream_name = 'PlatformServices_audit_session'
$log_list.add($log_location,$log_stream_Name)
$log_location = 'C:\LogFiles\epremis_web\pm.log'
$log_stream_name = 'PM'
$log_list.add($log_location,$log_stream_Name)
$log_location = 'c:\logfiles\PropensityToDenyAsyncRequestService*.log'
$log_stream_name = 'PropensityToDenyAsyncRequestService'
$log_list.add($log_location,$log_stream_Name)
$log_location = 'c:\logfiles\PropensityToDenyCleanUpService*.log'
$log_stream_name = 'PropensityToDenyCleanUpService'
$log_list.add($log_location,$log_stream_Name)
$log_location = 'c:\logfiles\PropensityToDenyRequestService*.log'
$log_stream_name = 'PropensityToDenyRequestService'
$log_list.add($log_location,$log_stream_Name)
$log_location = 'c:\logfiles\QVService*.log'
$log_stream_name = 'QVService'
$log_list.add($log_location,$log_stream_Name)
$log_location = 'D:\RabbitMQ\log\rabbit@*.log'
$log_stream_name = 'Rabbit'
$log_list.add($log_location,$log_stream_Name)
$log_location = 'D:\RabbitMQ\log\rabbit@*1_upgrade.log'
$log_stream_name = 'Rabbitupgrade'
$log_list.add($log_location,$log_stream_Name)
$log_location = 'C:\RelayHealth\RedisCache64\Logs\redis_log.txt'
$log_stream_name = 'Redis'
$log_list.add($log_location,$log_stream_Name)
$log_location = 'C:\LogFiles\AssuranceWeb\RelayHealthWeb.log'
$log_stream_name = 'RelayHealthWeb'
$log_list.add($log_location,$log_stream_Name)
$log_location = 'c:\logfiles\RemitMatchExtract*.log'
$log_stream_name = 'RemitMatchExtract'
$log_list.add($log_location,$log_stream_Name)
$log_location = 'c:\logfiles\RrtValidationService*.log'
$log_stream_name = 'RrtValidationService'
$log_list.add($log_location,$log_stream_Name)
$log_location = 'C:\ehospital\ScriptGen.txt'
$log_stream_name = 'ScriptGen'
$log_list.add($log_location,$log_stream_Name)
$log_location = 'C:\Program Files\RelayHealth\jboss-logs\Server.log'
$log_stream_name = 'Server'
$log_list.add($log_location,$log_stream_Name)
$log_location = 'c:\logfiles\session.log'
$log_stream_name = 'session'
$log_list.add($log_location,$log_stream_Name)
$log_location = 'c:\logfiles\SystemClaimAssigner*.log'
$log_stream_name = 'SystemClaimAssigner'
$log_list.add($log_location,$log_stream_Name)
$log_location = 'C:\RelayHealth\MemcachedService64\Logs\Traces\Traces*.log'
$log_stream_name = 'Trace'
$log_list.add($log_location,$log_stream_Name)
$log_location = 'c:\logfiles\ValidationQueueService*.log'
$log_stream_name = 'ValidationQueueService'
$log_list.add($log_location,$log_stream_Name)
$log_location = 'C:\Program Files\RelayHealth\wildfly-*\bin\run.*'
$log_stream_name = 'WildflyRun'
$log_list.add($log_location,$log_stream_Name)
$log_location = 'C:\Program Files\RelayHealth\wildfly-*\bin\Shutdown.*'
$log_stream_name = 'Wildflyshutdown'
$log_list.add($log_location,$log_stream_Name)
$log_location = 'C:\LogFiles\AssuranceAPI\RelayHealthAPI*'
$log_stream_name = 'RelayHealthAPI'
$log_list.add($log_location,$log_stream_Name)
$log_location = 'C:\LogFiles\AssuranceAPI\armui_web*'
$log_stream_name = 'armui_web'
$log_list.add($log_location,$log_stream_Name)
$log_location = 'C:\LogFiles\ZipManager*'
$log_stream_name = 'ZipManager'
$log_list.add($log_location,$log_stream_Name)
$log_location = 'D:\inetpub\logs\LogFiles\*\*'
$log_stream_name = 'IISlogs'
$log_list.add($log_location,$log_stream_Name)
##############################################################################
# Use for configuring CloudWatch Agent in Non-AMS hosted environments
#    In AMS hosted Windows machines ALL configurations are held in one master configuration file
#        C:\Program Files\WindowsPowerShell\Modules\AWSManagedServices.Logging.Utilities\Files\Config.json
#    AMS Windows machines run a process on reboot that removes all json configuration files in
#        C:\ProgramData\Amazon\AmazonCloudWatchAgent\Config 
#        and copy in only the AWSManagedServices will be copied back in
##############################################################################
# This script can be used to configure the cloudwatch agent via an octopus task
# This uses the same function as configure_cloudwatch_agent.ps1 to do the actual configuration
# log_stream_name provided in each hash table pair will have
#     spaces converted to _
#     .{logical-id}.{instance_id}.{hostname} will be appended to the end of the log_stream_name provided
#     Ex: example_log_stream.example_logical_id.id_12345.example_hostname
# log_location: The log file to be monitored (wildcards allowed) ex: /logs/test.*.log" 
##############################################################################
# Change the values below for your needs
########################################
# The log group name to use for all log locations
#$log_group_name = 'customer-CloudWatch-EC2-Windows-APP_ID-1800'
# A hash table of all of the log_location and log_stream combinations to configure
#$log_list = @{}
# Edit the below to reflect the log locations and corresponding log stream names
#$log_location = 'E:\LOGS\TCPServer.txt'
#$log_stream_name = 'CIC Inquiry TCP Service'
#$log_list.add($log_location,$log_stream_Name)
#####################################################################
################### Do not edit below ###############################
#####################################################################
$cwagent = "amazon-cloudwatch-agent"
$cwagent_service="AmazonCloudWatchAgent"
$cwagent_installdir = "C:\PROGRA~1\Amazon\AmazonCloudWatchAgent"
$cwagent_stat_dir = "C:\ProgramData\Amazon\AmazonCloudWatchAgent\Logs\state"
$log_file = "C:\ProgramData\Amazon\AmazonCloudWatchAgent\Logs\amazon-cloudwatch-agent.log"
$log_lines = 40
$ams_config = "C:\Program Files\WindowsPowerShell\Modules\AWSManagedServices.Logging.Utilities\Files\Config.json"
$ams_default_config = "$ams_config.default"
# Get the private ip to use to lookup the logical-id tag for this instance
$private_ip = $private_ip = ((ipconfig | findstr [0-9].\.)[0]).Split()[-1]
$command = "aws ec2 describe-instances --region us-east-1 --filters Name=private-ip-address,Values=$private_ip --query ""Reservations[*].Instances[*].{Name:Tags[?Key=='aws:cloudformation:logical-id']|[0].Value}"" --output text"
write-output $command
$logical_id = invoke-expression $command | Select-String -Pattern '\S'
Write-Output "Private IP = $private_ip"
Write-Output "Logical-ID = $logical_id"
function restore_default {
    $ams_default_config_content = "{
  ""agent"": {},
  ""logs"": {
      ""logs_collected"": {
          ""files"": {
              ""collect_list"": [
                  {
                      ""file_path"": ""C:\\ProgramData\\Amazon\\SSM\\Logs\\amazon-ssm-agent.log"",
                      ""log_group_name"": ""customer-CloudWatch-EC2-Agent"",
                      ""log_stream_name"": ""AmazonSSMAgentLog"",
                      ""timezone"": ""Local""
                  },
                  {
                      ""file_path"": ""C:\\ProgramData\\Amazon\\AmazonCloudWatchAgent\\Logs\\amazon-cloudwatch-agent.log"",
                      ""log_group_name"": ""customer-CloudWatch-EC2-Agent"",
                      ""log_stream_name"": ""AmazonCloudWatchAgentLog"",
                      ""timezone"": ""Local""
                  },
                  {
                      ""file_path"": ""C:\\ProgramData\\Amazon\\SSM\\Logs\\errors.log"",
                      ""log_group_name"": ""customer-CloudWatch-EC2-Agent"",
                      ""log_stream_name"": ""AmazonSSMErrorLog"",
                      ""timezone"": ""Local""
                  },
                  {
                      ""file_path"": ""C:\\cfn\\log\\cfn-init.log"",
                      ""log_group_name"": ""customer-CloudWatch-EC2-Agent"",
                      ""log_stream_name"": ""AmazonCloudFormationLog"",
                      ""timezone"": ""Local""
                  }
              ]
          },
          ""windows_events"": {
              ""collect_list"": [
                  {
                      ""event_name"": ""Application"",
                      ""event_levels"": [
                          ""ERROR"",
                          ""WARNING"",
                          ""INFORMATION""
                      ],
                      ""log_group_name"": ""customer-CloudWatch-EC2-Windows-Main"",
                      ""log_stream_name"": ""ApplicationEventLog.{instance_id}.{hostname}"",
                      ""event_format"": ""xml""
                  },
                  {
                      ""event_name"": ""EC2ConfigService"",
                      ""event_levels"": [
                          ""ERROR"",
                          ""WARNING"",
                          ""INFORMATION""
                      ],
                      ""log_group_name"": ""customer-CloudWatch-EC2-Windows-EC2Config"",
                      ""log_stream_name"": ""EC2ConfigServiceEventLog"",
                      ""event_format"": ""xml""
                  },
                  {
                      ""event_name"": ""Microsoft-Windows-AppLocker/EXE and DLL"",
                      ""event_levels"": [
                          ""ERROR"",
                          ""WARNING"",
                          ""INFORMATION""
                      ],
                      ""log_group_name"": ""customer-CloudWatch-EC2-Windows-Main"",
                      ""log_stream_name"": ""MicrosoftWindowsAppLockerEXEAndDLLEventLog.{instance_id}.{hostname}"",
                      ""event_format"": ""xml""
                  },
                  {
                      ""event_name"": ""Microsoft-Windows-AppLocker/MSI and Script"",
                      ""event_levels"": [
                          ""ERROR"",
                          ""WARNING"",
                          ""INFORMATION""
                      ],
                      ""log_group_name"": ""customer-CloudWatch-EC2-Windows-Main"",
                      ""log_stream_name"": ""MicrosoftWindowsAppLockerMSIAndScriptEventLog.{instance_id}.{hostname}"",
                      ""event_format"": ""xml""
                  },
                  {
                      ""event_name"": ""Microsoft-Windows-GroupPolicy/Operational"",
                      ""event_levels"": [
                          ""ERROR"",
                          ""WARNING"",
                          ""INFORMATION""
                      ],
                      ""log_group_name"": ""customer-CloudWatch-EC2-Windows-Main"",
                      ""log_stream_name"": ""MicrosoftWindowsGroupPolicyOperationalEventLog.{instance_id}.{hostname}"",
                      ""event_format"": ""xml""
                  },
                  {
                      ""event_name"": ""Security"",
                      ""event_levels"": [
                          ""ERROR"",
                          ""WARNING"",
                          ""INFORMATION""
                      ],
                      ""log_group_name"": ""customer-CloudWatch-EC2-Windows-Main"",
                      ""log_stream_name"": ""SecurityEventLog.{instance_id}.{hostname}"",
                      ""event_format"": ""xml""
                  },
                  {
                      ""event_name"": ""System"",
                      ""event_levels"": [
                          ""ERROR"",
                          ""WARNING"",
                          ""INFORMATION""
                      ],
                      ""log_group_name"": ""customer-CloudWatch-EC2-Windows-Main"",
                      ""log_stream_name"": ""SystemEventLog.{instance_id}.{hostname}"",
                      ""event_format"": ""xml""
                  }
              ]
          }
      }
  }
}"
    Write-Output "Restoring $ams_config to default"
    Set-Content -Path $ams_config $ams_default_config_content
    Write-Output "Restoring $ams_default_config to default"
    Set-Content -Path $ams_default_config $ams_default_config_content
    Write-Output "Clearing $cwagent_stat_dir"
    Remove-Item "$cwagent_stat_dir\*.log"
}
function add_app_config {
    $key_count = 0
    $log_list_size = $log_list.Count
    Write-Output "Adding application configuration to files: collect_list: section of $ams_config"
    foreach($log_location in $log_list.keys)
    {
        $key_count++
        $log_stream_name = $log_list.$log_location
        # Replace ' ' with '_' in log_stream_name
        $log_stream_name = $log_stream_name -replace ' ', '_'
        $file_path = $log_location
        if ((Select-String -InputObject $file_path -Pattern '\\') -and !(Select-String -InputObject $file_path -Pattern '\\\\')){
            $file_path = $file_path -replace '\\', '\\'
        }
        <#SAW is writing crap code#>
        if ($log_stream_name -eq 'IISlogs') {$log_group_name = 'customer-CloudWatch-EC2-Windows-IIS'} else {$log_group_name = 'customer-CloudWatch-EC2-Windows-APP_ID-1591'}
        $config_string = "                  {
                      ""file_path"": ""$file_path"",
                      ""log_group_name"": ""$log_group_name"",
                      ""log_stream_name"": ""$log_stream_name.$logical_id.{instance_id}.{hostname}"",
                      ""timezone"": ""Local"""
        Add-Content -Path $ams_config $config_string
        $last_line = "                  }"
        if($key_count -eq $log_list_size){
            Add-Content -Path $ams_config $last_line
        }
        else{
            Add-Content -Path $ams_config "$last_line,"
        }
    }
}
function parse_ams_cw_config {
    param (
        [string]$ams_config_in
    )
    $count = 0
    Write-Output "Reading $ams_config"
    Set-Content -Path $ams_config ""
    foreach($line in Get-Content $ams_config_in){
        # Check if this is the beginning of the "files": section
        if(Select-String -InputObject $line -Pattern '\"files\":\s+\{'){
            $count++
            #Add-Content -Path $ams_config $line
        }
        # Check if this is the beginning of the "collect_list": section
        if((Select-String -InputObject $line -Pattern '\"collect_list\":\s+\[') -and ($count -gt 0)){
            $count++
            #Add-Content -Path $ams_config $line
        }
        # Check if this is the last log configuration entry in the AMS file
        if((Select-String -InputObject $line -Pattern '^\s+\}$') -and ($count -gt 0)){
            $count = 0
            Add-Content -Path $ams_config "$line,"
            add_app_config
            $count = -1
        }
        #elseif(($count -lt 0) -or ($count -gt 0)){
        else{
            Add-Content -Path $ams_config $line
        }
    }
}
restore_default
if (Test-Path $ams_default_config){
    $date = Get-Date
    $date = $date.ToString('MMddyyhhmmss')
    $ams_old_config = "$ams_config.$date"
    Write-Output "$ams_default_config already exists"
    Write-Output "Copying $ams_config to $ams_old_conifg"
    Copy-Item $ams_config -Destination $ams_old_config
    Write-Output "and copying $ams_default_config to $ams_config"
}
else{
    Copy-Item $ams_config -Destination $ams_default_config
}
parse_ams_cw_config -ams_config $ams_default_config
# Update the CloudWatch Agent via the amazon-cloudwatch-agent-ctl script
$update_agent="$cwagent_installdir\amazon-cloudwatch-agent-ctl.ps1 -a fetch-config -m ec2 -s -c file:`"$ams_config`""
$update_agent+=';$?'
Write-Output "Running $update_agent"
$Success = Invoke-Expression $update_agent
# Copy in the default Config.json if the update fails and $restore_config is populated and retry the update
if ($Success -match 'False$'){
    Write-Error "$update_agent Failed"
    Write-Output "----------------- $log_file ----------------------"
    Get-Content -Tail $log_lines $log_file
    Write-Output "---------------------------------------------------------------"
}
else{
    Write-Output "$cwagent_service update complete, displaying the last $log_lines lines of $log_file"
    Write-Output "----------------- $log_file ----------------------"
    Get-Content -Tail $log_lines $log_file
    Write-Output "---------------------------------------------------------------"
    Write-Output "$cwagent_service update complete"
}
